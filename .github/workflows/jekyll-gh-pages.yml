name: Generar paquete para descarga

on:
  push:
    branches: ["master"]

  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write


concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout en Repo
        uses: actions/checkout@v3
      - name: Configurar Node.Js
        uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Instalar Angular CLI
        run: npm i -g @angular/cli
      - name: Instalar dependencias
        run: npm install
      - name: Generar paquete
        run: ng build --aot --base-href /frontend/
      - name: Crear paquete
        id: create_package
        run: tar -zcvf PrePackage.tar.gz ./dist/pastelesfe/
      - name: Instalar gdrive
        run: |
          wget -O gdrive_linux-x64.tar.gz https://github.com/glotlabs/gdrive/releases/download/3.9.0/gdrive_linux-x64.tar.gz
          tar -xf gdrive_linux-x64.tar.gz
          chmod +x gdrive
          sudo mv gdrive /usr/local/bin/
        shell: bash
      - name: Subir paquete a Drive
        env: 
          GDRIVE_ACCESS_TOKEN: ${{ secrets.GDRIVE_ACCESS_TOKEN }}
        run: |
          gdrive upload --token "$GDRIVE_ACCESS_TOKEN" PrePackage.tar.gz
      - name: Generar enlace de descarga
        id: download-link
        run: |
            GDRIVE_FILE_ID=$(gdrive list --query "name='PrePackage.tar.gz'" --no-header | awk '{ print $1 }')
            echo "https://drive.google.com/uc?export=download&id=${GDRIVE_FILE_ID}"
      
        
